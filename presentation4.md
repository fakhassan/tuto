---
## Front matter
lang: ru-RU
title: "Лабораторная работа №4. Захват почтового сервера"
subtitle: "Дисциплина: Кибербезопасность предприятия"
author:
  - Астраханцева Анастасия
  - Ганина Таисия
  - Ибатулина Дарья
  - Шошина Евгения
  - Кадирова Мехрубон
  - Хассан Факи Абакар

institute:
  - Группа НФИбд-01-22
  - Российский университет дружбы народов, Москва, Россия
date: 26 октября 2025

## i18n babel
babel-lang: russian
babel-otherlangs: english

## Formatting pdf
toc: false
toc-title: Содержание
slide_level: 2
aspectratio: 169
section-titles: true
theme: metropolis
header-includes:
 - \metroset{progressbar=frametitle,sectionpage=progressbar,numbering=fraction}
 - '\makeatletter'
 - '\beamer@ignorenonframefalse'
 - '\makeatother'
---

# Вводная часть

## Цель работы

Проверить защищённость учебного почтового сервера Microsoft Exchange методом имитации реальной цепочки атаки: от разведки и фингерпринтинга до валидации известных уязвимостей и подтверждения возможности удалённого выполнения кода (RCE). Итог — получить доказательство проникновения (флаг) и сформировать рекомендации по устранению рисков.

## Задачи

- Выполнить сетевую разведку подсети `195.239.174.0/24`.
- Идентифицировать OWA/почтовый сервис на `195.239.174.1` и собрать данные для фингерпринтинга.
- Сопоставить сборку Exchange с CVE/KB и отфильтровать CVSS ≥ 9, public exploit.
- В лабораторной среде проверить векторы (символически — через модули фреймворков) и получить артефакты.
- Подготовить выводы и практические рекомендации.

# Теоретическое введение

## Поверхность атаки Microsoft Exchange
- Сервисы: SMTP, OWA, EWS, Autodiscover и т.д.
- Web-интерфейс (OWA) и HTTP(S) — основной вектор внешнего доступа.
- Ошибки в обработке внешних запросов приводят к SSRF, обходам аутентификации и RCE.

## Классы уязвимостей, релевантные Exchange
- SSRF / ProxyLogon (например, CVE-2021-26855).
- Уязвимости цепочки, приводящие к RCE (ProxyShell: CVE-2021-34473, CVE-2021-34523 и др.).
- Запись файлов / web-shells → полный контроль сервера.

# Оценка риска

## Метрики и источники
- CVSS — числовая оценка критичности; критично при ≥ 9.
- EPSS — вероятность эксплуатации в ближайшем периоде.
- Источники: CVE, CVEdetails, Microsoft KB, Metasploit (модули).

## Подход к приоритезации
1. Фильтр по CVSS ≥ 9.
2. Наличие пометок `Public exploit` / `Known exploited`.
3. Совпадение дат: дата сборки сервера vs disclosure/first seen CVE.

# Инструменты и методология

## Инструменты, использованные в работе
- nmap — сетевое сканирование подсети;
- Браузер + DevTools — фингерпринтинг OWA;
- CVE/CVEdetails, Microsoft KB — сверка сборок;
- Metasploit (msf6) — модули для валидации/эксплуатации (в тестовой среде);
- Лабораторный стенд — все действия только в рамках разрешённой среды.

## Методика
- Сканирование подсети → идентификация хоста → фингерпринтинг HTTP/OWA → сопоставление сборки → приоритезация CVE → безопасная проверка (Metasploit в стенде) → сбор артефактов.

# Разведка — обнаружение цели

## Результат сканирования подсети
- Цель: `195.239.174.1`
- Открытые порты: `25/tcp (SMTP)`, `443/tcp (HTTPS)` — признак Exchange + OWA.
- Инструмент: `nmap -sS -p- 195.239.174.0/24`

![Результат сканирования сети — вывод nmap, обнаружены порты 25 и 443](image/2.png){#fig:scan width=60% height=60%}

**Вывод:** публичный OWA — критическая поверхность атаки.

# Фингерпринтинг OWA

## Что было сделано
- Открыли `https://195.239.174.1/` в браузере.
- Через DevTools исследовали HTML/ресурсы и HTTP-заголовки.
- Выявлены маркеры, позволяющие определить сборку Exchange (`15.1.1713`).

![Получение версии Exchange через режим разработчика — «Inspect (Q)»](image/4.png){#fig:devtools width=60% height=60%}

## Что было сделано

![Анализ HTML/ресурсов в DevTools — выделение строки с ресурсом/версией](image/5.png){#fig:devtools2 width=60% height=60%}

**Рекомендации:** сохранить HTML/ресурсы, снять заголовки `curl --head`.

# Сопоставление сборки с CVE / KB

## Процесс
- По найденной сборке (`15.1.1713`) выполнена сверка с таблицей сборок Microsoft и базой CVE.
- Фильтр: CVSS ≥ 9, public exploit / known exploited.

![Дата выпуска сборки Exchange и сопоставление с номерами сборок/KB](image/6.png){#fig:builds width=60% height=60%}

## Процесс

![Таблица соответствия Exchange CU → номер сборки (выделено 15.01.1713)](image/6.1.png){#fig:builds2 width=60% height=60%}

**Ключевые CVE, выделенные к проверке:**
- CVE-2021-26855 (ProxyLogon, SSRF)
- CVE-2021-34473 (ProxyShell, RCE)
- CVE-2021-34523, CVE-2021-31207 (составные уязвимости ProxyShell)

# Приоритезация и подтверждение эксплойтов

## Поиски в CVE / CVEdetails
- Анализ страниц CVE: EPSS, наличие публичных PoC, модули Metasploit.
- Приоритет — уязвимости с пометкой `Public exploit` / `Known exploited`.

![Стартовая страница CVEdetails — поиск и справочные данные по уязвимостям](image/7.png){#fig:cvedetails width=60% height=60%}

## Поиски в CVE / CVEdetails

![Приоритезация уязвимостей Microsoft Exchange Server (CVSS >= 9)](image/8.png){#fig:prior width=60% height=60%}

**Вывод:** наличие публичных модулей и высокий EPSS повышают приоритет реагирования.

# Подготовка Metasploit (лабораторная проверка)

## Процесс
- Запуск `msf6`;
- `search exchange` → просмотр доступных модулей (`exchange_proxyshell_rce`, `exchange_proxylogon_rce` и др.);
- Конфигурация rhosts/lhost/параметров и запуск модулей в стенде.

![Запуск Metasploit и поиск модулей по Exchange (вывод `search Exchange`)](image/11.png){#fig:msf_search width=60% height=60%}

## Процесс

![Перечень модулей Metasploit, предназначенных для атак на Exchange (выделены модули RCE/ProxyShell/ProxyLogon)](image/12.png){#fig:msf_modules width=60% height=60%}

**Важно:** эксплуатация — ТОЛЬКО в тестовой среде и с разрешением.

# Эксплуатация — ProxyShell 

## Наблюдения
- Модуль ProxyShell успешно отправил полезную нагрузку.
- Открыта Meterpreter-сессия.
- Получен доступ к файловой системе, считан флаг.

![Вывод Metasploit — успешная эксплуатация ProxyShell и открытие Meterpreter-сессии](image/14.png){#fig:msf_exploit width=60% height=60%}

## Наблюдения

![Чтение файла флага в Meterpreter](image/15.png){#fig:flag width=40%}

**Артефакт:** `C:\Windows\System32\flag_for_red_team.txt = 81596`

# Эксплуатация — ProxyLogon

## Наблюдения
- Альтернативный вектор ProxyLogon также дал Meterpreter-сессию.
- Эксплуатация возможна через цепочку CVE-2021-26855 + CVE-2021-27065.
- Полученные артефакты совпадают с результатами ProxyShell.

![Пример установки параметров модуля и запуска ProxyLogon (вывод Metasploit)](image/17.png){#fig:proxylogon1 width=60% height=60%}

## Наблюдения

![Вывод успешной эксплуатации ProxyLogon — открыта Meterpreter-сессия](image/18.png){#fig:proxylogon2 width=60% height=60%}

**Вывод:** множественные точки входа RCE → высокий риск.

## Проблемы при эксплуатации и наблюдения

- Встречались ошибки доступа к файлам, но финально флаг был считан (`81596`).
- Важна запись всех timestamp'ов и логов Metasploit для корректного аудита.

![Ошибки доступа и последующее успешное чтение файла флага в Meterpreter](image/19.png){#fig:issues width=60% height=60%}

## Собранные артефакты

- Логи `nmap` — выводы сканирования.
- Снимки DevTools / HTML ресурсы (фингерпринт).
- Страницы CVE / CVEdetails (EPSS, public exploit).
- Логи Metasploit — полные сессии, временные метки.
- Содержимое флага: `C:\Windows\System32\flag_for_red_team.txt = 81596`.

# Итоги и выводы

## Рекомендации по реагированию и защите (кратко)

1. **Изоляция:** немедленно изолировать хост `195.239.174.1` (VLAN/ACL).  
2. **Сбор артефактов:** журналы IIS, Application, Security, Exchange; дампы памяти; файлы из `FrontEnd\HttpProxy\owa\`.  
3. **Патчи:** установить все security updates/KB для версии Exchange; проверить соответствие CU.  
4. **Учётные данные:** отозвать/сменить скомпрометированные учетные записи и сертификаты.  
5. **Поиск следов постэксплуатации:** web-shells, новые учётные записи, планировщики задач, изменение почтовых правил.  
6. **Усиление доступа:** ограничение доступа к ECP/OWA по IP, WAF, MFA для админов.  
7. **Мониторинг:** IDS/IPS правила для ProxyLogon/ProxyShell, логирование и корреляция событий.

## Этика и правовые аспекты

- Все активности — только в рамках лабораторного стенда или при явном письменном разрешении.
- Нелегальная эксплуатация — преступление.
- Документируйте каждое действие: кто, когда, какие данные и почему — для аудита и возможного судебного следствия.

## Выводы

1. Обнаружен и подтверждён почтовый сервер `195.239.174.1` с OWA и SMTP.  
2. Фингерпринтинг показал сборку `15.1.1713`, что позволило соотнести с критичными CVE.  
3. Приоритетные уязвимости (CVE-2021-26855, CVE-2021-34473 и др.) имели публичные эксплойты и модули Metasploit.  
4. В лабораторных условиях подтверждена возможность RCE и получен флаг `81596`.  
5. Рекомендованы немедленные меры: изоляция, сбор артефактов, патчи, смена учетных данных, усиление контроля доступа и мониторинга.

