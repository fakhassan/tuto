---
## Front matter
title: "Отчёт по лабораторной работе №4"
subtitle: "ЗАХВАТ ПОЧТОВОГО СЕРВЕРА"
author: |
  Астраханцева Анастасия  
  Ибатулина Дарья  
  Ганина Таисия  
  Шошина Евгения  
  Кадирова Мехрубон  
  Хассан Факи Абакар  
  (группа НФИбд-01-22)

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: false # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
    - spelling=modern
    - babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: PT Serif
romanfont: PT Serif
sansfont: PT Sans
monofont: PT Mono
mainfontoptions: Ligatures=TeX
romanfontoptions: Ligatures=TeX
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase
monofontoptions: Scale=MatchLowercase,Scale=0.9
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Проверить на учебном стенде защищённость почтового сервера Microsoft Exchange методом имитации реальной цепочки атаки: от разведки и фингерпринтинга до валидации наличия известных уязвимостей и подтверждения возможности удалённого выполнения кода (RCE).  
В качестве итогового артефакта — получить доказательство проникновения (флаг) и подготовить рекомендации по устранению обнаруженных рисков.

# Задание

1. Выполнить разведку сети и обнаружить активные хосты в подсети `195.239.174.0/24`. Зафиксировать открытые порты и сервисы, представляющие интерес для почтовой инфраструктуры.  
2. Идентифицировать веб-интерфейс OWA / почтовый сервис на целевом хосте (`195.239.174.1`) и собрать информацию, необходимую для фингерпринтинга версии сервера (страницы, ресурсы, заголовки).  
3. Сопоставить найденную версию сборки Exchange с публичными базами уязвимостей (CVE, KB, EPSS) и выбрать приоритетные CVE для дальнейшей проверки (фильтр: CVSS ≥ 9, наличие пометок `Public exploit` / `Known exploited`).  
4. В лабораторной среде проверить наличие верифицируемых векторов (символически — через готовые модули фреймворков), подтвердить возможность получения интерактивной сессии на целевой системе **только в рамках разрешённого стенда**. Зафиксировать найденный флаг и все артефакты.  
5. Подготовить отчёт: выводы по разведке, соответствие сборки уязвимостям, полученные артефакты (скриншоты, логи), оценку риска и практические рекомендации по устранению и предотвращению повторной компрометации.

# Теоретическое введение

## 1. Поверхность атаки Microsoft Exchange
Microsoft Exchange — комплексный почтовый сервер с компонентами, доступными по сети (SMTP, OWA, EWS, Autodiscover и т. д.). Наличие публичного веб-интерфейса (OWA) и сервисов, обрабатывающих удалённые запросы, делает Exchange привлекательной целью: уязвимости в обработке внешних запросов могут привести к обходу аутентификации или удалённому выполнению кода.

## 2. Классы уязвимостей, применимых к Exchange
- **SSRF (Server-Side Request Forgery)** — позволяет злоумышленнику вынудить сервер выполнить запросы к внутренним конечным точкам от имени сервера (основной вектор ProxyLogon — CVE-2021-26855).  
- **Привилегированная эскалация / подделка контекста** — уязвимости, позволяющие выдавать себя за сервисную учётную запись или переключать контекст (см. CVE-2021-34523 и CVE-2021-31207).  
- **Запись произвольного файла / web-shell / RCE** — возможность записать на сервер файл, который затем может выполнить код (CVE-2021-34473 и связанные CVE), обеспечивая полноценную удалённую эксплуатацию.

## 3. Оценка риска: CVSS и EPSS
- **CVSS (Common Vulnerability Scoring System)** предоставляет количественную оценку критичности уязвимости (конфиденциальность, целостность, доступность, сложность эксплуатации и т.д.). Значения ≥ 9 указывают на критические уязвимости.  
- **EPSS (Exploit Prediction Scoring System)** измеряет вероятность реальной эксплуатации уязвимости в ближайшие 30 дней — высокий EPSS указывает на практическую опасность (наличие публичных PoC/эксплойтов или активность в дикой природе).

## 4. Инструменты разведки и фингерпринтинга
- **Сетевое сканирование** (идентификация хостов и открытых портов) — помогает найти сервисы, доступные извне (SMTP, HTTPS и др.).  
- **Фингерпринтинг веб-интерфейса** — анализ HTML/ресурсов и HTTP-заголовков для определения версии приложения/сборки; DevTools браузера и заголовки ответа помогают установить соответствие версии с таблицами сборок.  
- **Базы уязвимостей** — CVE, CVEdetails, Microsoft Security Bulletins, CISA KEV: используются для поиска известных проблем, дат раскрытия и наличия публичных эксплойтов.

## 5. Фреймворки для проверки
- **Metasploit** — фреймворк, содержащий модули для поиска, валидации и (в тестовой среде) эксплуатации уязвимостей. В образовательном и тестовом контексте Metasploit позволяет подтвердить наличие работоспособного вектора и собрать артефакты.  
> Важно: использование эксплойтов и активная эксплуатация допускаются **только** в лабораторных условиях или с явного письменного разрешения владельца инфраструктуры. Незаконное использование — преступление.

## 6. Постэксплуатация и артефакты
После успешной эксплуатации атакующий может получить интерактивную сессию (например, Meterpreter), что позволяет: просматривать файловую систему, извлекать конфиденциальные данные, устанавливать постоянные механизмы доступа (backdoor) и выполнять дальнейшее перемещение по сети. Для отчёта важны: логи соединений, снимки экрана, содержимое целевых файлов (флаг), хэши и временные метки действий.

## 7. Меры защиты
- Регулярно применять security updates / cumulative updates для Exchange.  
- Ограничить доступ к OWA/EWS (WAF, ACL, IP-фильтрация), внедрить MFA для административных аккаунтов.  
- Мониторинг: IDS/IPS/WAF правила для выявления попыток эксплуатации ProxyLogon/ProxyShell, анализ аномалий в журналах Exchange и IIS.  
- Форензика и инцидент-респонс: собрать логи, образ памяти, и провести проверку на web-shells и следы постэксплуатации при подозрениях на компрометацию.

# Выполнение лабораторной работы

## Описание сценария

На внешнем периметре расположен почтовый сервер организации, необходимо получить доступ к флагу, расположенному в папке `С:Windows\system32\`.

## Разведка на предмет поиска вектора атаки

Для обнаружения потенциальных целей и оценки поверхности атаки выполнены сканирование подсети и анализ веб-интерфейса. В качестве инструментов использовались: `nmap`, веб-браузер с DevTools (режим «Inspect»), поиск по базам уязвимостей (CVEdetails).

**Инструменты и фильтры:**  
`nmap -sS -p- 195.239.174.0/24`, просмотр веб-страниц через HTTPS с включённым режимом разработчика, сверка сборок Exchange с KB и CVE.

### Инцидент 1: Обнаружение почтового сервера (Exchange) на `195.239.174.1`

**Что произошло:**  
В результате сканирования подсети `195.239.174.0/24` (утилита `nmap`) был обнаружен хост `195.239.174.1` с открытыми портами **25/tcp (smtp)** и **443/tcp (https)** — признак наличия почтового сервера с веб-интерфейсом OWA (Outlook Web Access). (рис. @fig:02, @fig:08)

**Что это означает:**  
Наличие SMTP и HTTPS на одном хосте сильно коррелирует с развёрнутым Microsoft Exchange. Публичный OWA делает сервер потенциальной целью для известных уязвимостей (например, ProxyLogon), что позволяет атакующему получить доступ к почтовым ящикам и выполнить пост-эксплуатационные операции.

**Индикаторы и артефакты:**  
- IP цели: `195.239.174.1`.  
- Открытые порты: `25/tcp`, `443/tcp`.  
- Инструмент: `nmap` (см. вывод сканирования).  
- Веб-интерфейс: `https://195.239.174.1/`.  

**Рекомендации:**  
1. Сохранить лог сканирования `nmap`.  
2. Ограничить доступ к OWA (ACL/WAF, MFA).  
3. Развернуть фронтенд/proxy для OWA и настроить мониторинг HTTPS-доступа.

(рис. @fig:02)

![Результат сканирования сети — вывод nmap, обнаружены порты 25 и 443](image/2.png){#fig:02 width=70%}

### Инцидент 2: Фингерпринтинг версии Exchange через DevTools

**Что произошло:**  
Через веб-интерфейс OWA открыта панель разработчика (Inspect) и проанализированы HTML/ресурсы страницы — обнаружены маркеры, позволяющие идентифицировать версию/сборку Exchange (атрибуты в `link`/`script`, комментарии). (рис. @fig:04, @fig:05)

**Что это означает:**  
Определение точной версии (например, `15.1.1713`) позволяет соотнести инсталляцию с известными исправлениями и CVE. Если сборка совпадает с уязвимой (до применения KB5000871 и т.п.), сервер может быть уязвим к эксплойтам ProxyLogon и связанным уязвимостям.

**Индикаторы и артефакты:**  
- Метод: правый клик → *Inspect (Q)* → просмотр HTML/ресурсов.  
- Найденные маркеры версии: выделенные строки/ресурсы в DevTools (см. рис. @fig:05).  
- Примеры связанных KB: `KB5000871`.  

**Рекомендации:**  
1. Снять снапшот DevTools и сохранить HTML/ресурсы.  
2. Получить HTTP-заголовки (`curl --head`) для подтверждения.  
3. Сверить сборку с официальной таблицей Microsoft и применить недостающие security updates.

(рис. @fig:04, @fig:05)

![Получение версии Exchange через режим разработчика — «Inspect (Q)»](image/4.png){#fig:04 width=70%}

![Анализ HTML/ресурсов в DevTools — выделение строки с ресурсом/версией](image/5.png){#fig:05 width=70%}

### Инцидент 3: Сопоставление сборки с бюллетенями и CVE

**Что произошло:**  
По найденной сборке произведён поиск в справочных источниках Microsoft и в базе CVE (CVEdetails). На скриншотах видны таблицы сборок Exchange и соответствующие KB (включая `KB5000871` и сборку `15.1.1713`). (рис. @fig:06, @fig:06.1, @fig:07)

**Что это означает:**  
Если развернутая версия совпадает с небезопасной сборкой, сервер подлежит немедленной проверке и экстренному обновлению. Наличие соответствующих CVE (например, CVE-2021-26855) увеличивает риск эксплуатации.

**Индикаторы и артефакты:**  
- Обнаруженные версии/сборки: `15.1.1713`.  
- Сопутствующие KB: `KB5000871`.  
- Источники: `cvedetails.com`.  

**Рекомендации:**  
1. Проверить установленные обновления на сервере (PowerShell: `Get-ExchangeServer | Format-List Name,AdminDisplayVersion`).  
2. При отсутствии патчей — провести экстренное применение security updates (с резервной копией и тестированием).  
3. При признаках компрометации — изолировать сервер, собрать логи (IIS, Application, Security), дампы памяти и запустить IOC-сканирование на web-shells и признаки ProxyLogon.

(рис. @fig:06, @fig:06.1, @fig:07)

![Дата выпуска сборки Exchange Server и сопоставление с номерами сборок/KB](image/6.png){#fig:06 width=70%}

![Таблица соответствия Exchange CU → номер сборки (выделено 15.01.1713)](image/6.1.png){#fig:06.1 width=70%}

![Стартовая страница CVEdetails — поиск и справочные данные по уязвимостям](image/7.png){#fig:07 width=70%}

Для оценки возможности эксплуатации использовалась база CVE (CVEdetails) с фильтром по продукту **Microsoft Exchange Server** и порогом **CVSS >= 9**. Это позволило выделить уязвимости с высокой степенью риска и метками наличия публичных эксплойтов / фактов эксплуатации в дикой природе (public exploit exists / Known exploited). (рис. @fig:08)

- Методика: фильтр CVSS ≥ 9 → сортировка по меткам «Public exploit» / «Known exploited» → просмотр подробностей CVE (дата раскрытия, EPSS, наличие модулей Metasploit).

#### Инцидент 4: Приоритезация уязвимостей через CVE-поисковик

**Что произошло:**  
На сервере/в окружении была сопоставлена версия Exchange с записями CVE. По результатам фильтрации получен список приоритетных уязвимостей, помеченных как **Public exploit** или **Known exploited** — их эксплуатация доказана на практике. (рис. @fig:08)

**Что это означает:**  
Если дата раскрытия уязвимости (*Disclosure Date*) позже даты выпуска сборки сервера — значит уязвимость не была исправлена в этой сборке и может быть эксплуатируема против указанного сервера. Наличие публичного эксплойта (и особенно — модуля Metasploit) значительно упрощает автоматизацию атаки и повышает приоритет реагирования. (рис. @fig:09, @fig:10)

**Индикаторы и артефакты:**  
- Источник разведки: `cvedetails.com`.  
- Примеры CVE с высокой вероятностью эксплуатации: `CVE-2021-34473`, `CVE-2021-34523`, `CVE-2021-34527` (см. страницы CVE — EPSS/метасплоит-модули). (рис. @fig:09, @fig:10)  
- Метки: `Public exploit`, `Known exploited`, EPSS > 90% — повышенный риск. (рис. @fig:09)

**Рекомендации:**  
1. Немедленно сверить список CVE с реальной версией сервера (как минимум — календарная дата сборки против даты публикации CVE).  
2. Сфокусировать первичную защиту и проверку на уязвимостях с метками `Public exploit` и `Known exploited`.  
3. При обнаружении соответствия — подготовить план экстренного патч-менеджмента и расследования на предмет следов эксплуатации.

(рис. @fig:08)

![Приоритезация уязвимостей Microsoft Exchange Server (CVSS >= 9)](image/8.png){#fig:08 width=70%}

#### Детальная проверка CVE (пример)

**Что просмотрено:**  
Страницы CVE показывают: EPSS / вероятность эксплуатации, наличие модулей Metasploit и даты — *Disclosure Date* и *First seen* (появление эксплойтов в публичных репозиториях). Это даёт временную корреляцию между выпуском сборки сервера и появлением эксплойтов. (рис. @fig:09)

**Вывод:**  
Если *Disclosure Date* (дата раскрытия уязвимости) **позже** даты сборки сервера — уязвимость может быть использована против текущей установки.

(рис. @fig:09)

![Детальная информация по уязвимости (пример CVE-2021-34473) — EPSS, Metasploit module, Disclosure/First seen](image/9.png){#fig:09 width=70%}

### Подготовка и использование Metasploit для поиска векторов

Для практической проверки возможности RCE и получения сессии использовался фреймворк Metasploit:

- Запуск msf6 → `search Exchange` → просмотр доступных модулей (включая `exchange_proxylogon_rce`, `exchange_proxyshell_rce`, `exchange_proxynothell_rce` и т.д.). (рис. @fig:11, @fig:12)  
- Метасплоит-модули подтверждают наличие готовых реализаций эксплойтов для ряда CVE, что облегчает эксплуатацию.

**Индикаторы и артефакты:**  
- Локальный вывод Metasploit: список модулей и их даты/статусы (рис. @fig:11).  
- Наличие модулей с пометкой `excellent/Yes` (готов к использованию). (рис. @fig:11)

**Рекомендации:**  
1. Использовать Metasploit **только** в рамках тестовой/лабораторной среды или с письменного разрешения владельца инфраструктуры.  
2. Для проверки уязвимости — сначала выполнить безопасную валидацию без эксплуатации (fingerprinting, запросы HEAD, проверка заголовков, тестирование на тестовом стенде).  
3. При подтверждении уязвимости — подготовить план реагирования: сбор логов, резервное копирование, установка патчей, последующий аудит и мониторинг.

(рис. @fig:11, @fig:12)

![Запуск Metasploit и поиск модулей по Exchange (вывод `search Exchange`)](image/11.png){#fig:11 width=70%}

![Перечень модулей Metasploit, предназначенных для атак на Exchange (выделены модули RCE/ProxyShell/ProxyLogon)](image/12.png){#fig:12 width=70%}

## Эксплуатация уязвимостей и захват флага (результаты)

В ходе практической работы подтверждена возможность получения RCE на почтовом сервере `195.239.174.1` с применением публичных модулей Metasploit (ProxyShell / ProxyLogon). Ниже — структурированная сводка наблюдений, артефактов и выводов.

### Инструменты и условия
- Среда атакующего: Kali Linux с установленным Metasploit (msf6).  
- Цель: `195.239.174.1` (Microsoft Exchange — OWA + SMTP).  
- Источники артефактов: выводы Metasploit, сессии Meterpreter, снимки экрана DevTools и страницы CVE.

### Эксплуатация ProxyShell (итоги)

**Описание наблюдаемого процесса:**  
Модуль для ProxyShell (ProxyShell RCE, связанный с CVE-2021-34473 / CVE-2021-34523 / CVE-2021-31207) был запущен из фреймворка Metasploit. В выводе показано, что модуль успешно отправил полезную нагрузку на целевой сервер, удалённый хост отработал, и была открыта Meterpreter-сессия.

**Ключевые наблюдения (логи/вывод):**  
- Запуск обработчика обратного соединения (reverse TCP handler).  
- Сообщение: `The target is vulnerable.`  
- Успешные этапы: получение FQDN backend, поиск валидных почтовых ящиков, создание и отправка черновика с webshell-аттачем, ожидание обратного подключения.  
- Открыта `Meterpreter session 1` — подтверждение RCE. (рис. @fig:14)

![Вывод Metasploit — успешная эксплуатация ProxyShell и открытие Meterpreter-сессии](image/14.png){#fig:14 width=70%}

**Полученные артефакты:**  
- Открытая Meterpreter-сессия (запись в консоли).  
- Флаг найден по пути `C:\windows\system32\flag_for_red_team.txt` — содержимое: `81596`. (рис. @fig:15)

![Чтение файла флага в Meterpreter](image/15.png){#fig:15 width=40%}

**Вывод:** эксплуатация ProxyShell привела к получению интерактивной сессии и извлечению артефакта — флага. Это подтверждает реальную возможность RCE на исследуемом сервере при текущей конфигурации/сборке.

### Альтернативная эксплуатация ProxyLogon (итоги)

**Описание:**  
Для проверки альтернативного вектора использовался модуль, реализующий ProxyLogon (CVE-2021-26855 + связанная логика записи файла — CVE-2021-27065). В качестве целевого почтового ящика применялся адрес `manager1@ampire.corp` (легитимная служебная запись, обнаруженная в портале). В выводах также показан успешный цикл эксплуатации и открытие Meterpreter-сессии.

**Ключевые наблюдения (логи/вывод):**  
- Настройка параметров модуля (rhosts, lhost, EMAIL).  
- Сообщения модуля: `The target is vulnerable to CVE-2021-26855` / отправка MAPI/ProxyLogon-запросов / подготовка и запись полезной нагрузки.  
- Открыта дополнительная Meterpreter-сессия (время/порты видны в выводе). (рис. @fig:17–@fig:18)

![Пример установки параметров модуля и запуска ProxyLogon (вывод Metasploit)](image/17.png){#fig:17 width=70%}

![Вывод успешной эксплуатации ProxyLogon — открыта Meterpreter-сессия](image/18.png){#fig:18 width=70%}

**Вывод:** проксимальные уязвимости ProxyLogon также позволяют получить RCE и доступ к файловой системе сервера; подтверждена возможность извлечения флага через оба канала.

### Проблемы и замечания при работе с сессиями

- В некоторых попытках наблюдались сообщения об ошибках доступа к файлам (например, `Operation failed: The system cannot find the file specified.`), однако последующие команды `cat C:\windows\system32\flag_for_red_team.txt` успешно возвращали содержимое флага — `81596`. (рис. @fig:19)  
- Метки `Disclosure Date / First seen` и наличие модулей Metasploit для соответствующих CVE позволяют объяснить, почему эксплуатация возможна в лабораторных/реальных условиях (см. раздел 2.2).

![Ошибки доступа и последующее успешное чтение файла флага в Meterpreter](image/19.png){#fig:19 width=70%}

### Артефакты для отчёта и дальнейшего расследования
- Выводы `nmap` и скриншоты OWA/DevTools (фингерпринт версии).  
- Страницы CVE/CVEdetails с метками «Public exploit / Known exploited» и информацией по модулям Metasploit (см. раздел 2.2).  
- Логи Metasploit: полные сессии атак, таймстемпы открытия Meterpreter.  
- Содержимое флага `C:\windows\system32\flag_for_red_team.txt = 81596` (снимок вывода).  
- Сохранённые черновики/файлы, которые модуль создавал на сервере (если доступны).

### Рекомендации по реагированию
1. **Немедленно изолировать** сервер `195.239.174.1` от сети (VLAN/ACL).  
2. **Собрать артефакты**: журналы IIS, Application, Security, Exchange, PowerShell; образ памяти; дампы файлов, созданных в `FrontEnd\HttpProxy\owa\`.  
3. **Провести форензик**: поиск web-shell, новых учётных записей, подозрительных задач/служб, изменений в почтовых ящиках.  
4. **Применить патчи**: установить все security updates/KB, относящиеся к CVE-2021-26855 / CVE-2021-34523 / CVE-2021-34473 и соответствующие CU для вашей версии Exchange.  
5. **Поменять/отозвать** скомпрометированные учётные данные и сертификаты.  
6. **Повысить мониторинг**: IDS/WAF правила для OWA/EWS, контроль целевых вызовов EWS/Autodiscover, детектирование массовых экспортов почтовых ящиков.

# Выводы по работе

В результате выполнения лабораторной работы были успешно реализованы этапы разведки, анализа уязвимостей, их эксплуатации и получения удалённого доступа к почтовому серверу Microsoft Exchange.

1. **Проведена разведка сети.**  
   Сканированием подсети `195.239.174.0/24` выявлен активный хост `195.239.174.1` с открытыми портами `25/tcp` (SMTP) и `443/tcp` (HTTPS), что позволило идентифицировать сервер Microsoft Exchange.

2. **Выполнено определение версии Exchange.**  
   С помощью инструментов DevTools в браузере получены сведения о сборке сервера (`15.1.1713`), что позволило соотнести её с известными бюллетенями Microsoft и выявить неустановленные обновления безопасности.

3. **Проведён анализ CVE и приоритезация угроз.**  
   Используя портал CVEdetails, определены наиболее критические уязвимости (CVSS ≥ 9), имеющие публичные эксплойты и зафиксированные случаи эксплуатации:
   - CVE-2021-26855 (ProxyLogon, SSRF);
   - CVE-2021-34473 (ProxyShell, RCE);
   - CVE-2021-34523, CVE-2021-31207 (связанные компоненты цепочки ProxyShell).

4. **Подтверждено наличие эксплуатационных модулей.**  
   В Metasploit обнаружены соответствующие модули (`windows/http/exchange_proxyshell_rce`, `windows/http/exchange_proxylogon_rce`), что подтвердило возможность автоматизации атаки.

5. **Реализована эксплуатация ProxyShell.**  
   При запуске модуля ProxyShell подтверждена уязвимость сервера, создан черновик с webshell, и установлена `Meterpreter`-сессия с удалённым сервером. В каталоге `C:\Windows\System32\` найден флаг `flag_for_red_team.txt` с содержимым `81596`.

6. **Реализована эксплуатация ProxyLogon.**  
   Аналогичный результат получен при использовании модуля ProxyLogon RCE — также открыта сессия и прочитан тот же флаг, что подтверждает множественные точки входа для RCE.

7. **Проведён анализ результатов и сформулированы меры реагирования.**  
   Полученные результаты демонстрируют критическую уязвимость сервера, отсутствие актуальных обновлений безопасности и возможность удалённого исполнения кода с привилегиями администратора.
